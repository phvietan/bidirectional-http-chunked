<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  Please see console for output
  <br />
  --------------------------------------------
  <br />
  The main fetch with body should throw error because browser does not allow both response and request to be chunked
  <br />
  The fetch without body should went through, but server response "Request does not have body" and not run the challenge
  <br />
  --------------------------------------------

  <script>

    async function connectWithoutBody() {
      const response = await fetch('/', {
        method: 'POST',
      });
      const reader = response.body.getReader();

      const {value} = await reader.read();
      const text = new TextDecoder().decode(value);
      console.log('[no-body] Received', text);

      console.log('[no-body] Response fully received');
    }

    async function main() {
      var globalController;
      const response = await fetch('/', {
        method: 'POST',
        duplex: 'half',
        body: new ReadableStream({
          start(controller) {
            globalController = controller;
          }
        })
      });
      const reader = response.body.getReader();

      const {value} = await reader.read();
      const text = new TextDecoder().decode(value);
      console.log('[main] Received', text);

      console.log('[main] Response fully received');
    }

    main();
    connectWithoutBody();
  </script>
</body>

</html>
